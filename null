---
keyword: [迁移Lightning至MaxCompute BI加速版, 最佳实践, Hologres]
---

# 迁移Lightning至共享集群（MaxCompute BI加速版）

本文为您介绍迁移原有Lightning服务至共享集群（MaxCompute BI加速版）的最佳实践。

共享集群（MaxCompute BI加速版）是针对MaxCompute交互式分析场景设计的在线查询加速服务，基于Hologres存储计算分离的云原生架构，以共享集群资源的形式，加快存储在MaxCompute中的数据访问。

您可以将共享集群（MaxCompute BI加速版）认为是Lightning的升级版，性能和服务更优于Lightning。

**说明：** Lightning后期会逐步下线，下线后不再继续维护，建议您选择共享集群（MaxCompute BI加速版）处理业务。

## 操作流程

Lightning与共享集群（MaxCompute BI加速版）的操作流程区别如下图所示。

![迁移Lighting至共享集群](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0031579061/p184902.png)

-   开通共享集群（MaxCompute BI加速版）后，您必须先新建一个数据库。
-   修改原开发工具中Lightning的Eendpoint为共享集群（MaxCompute BI加速版）的Endpoint。
-   共享集群（MaxCompute BI加速版）是通过新建外部表的方式加速查询MaxCompute数据，因此在查询之前，您必须先创建一张与之映射的外部表。
-   修改原BI工具中Lightning的Endpoint为共享集群（MaxCompute BI加速版）的Endpoint。

## 操作步骤

1.  开通共享集群（MaxCompute BI加速版）。

    1.  使用阿里云主账号登录[阿里云官网](https://www.aliyun.com/)。

    2.  进入[Hologres产品详情页](https://www.aliyun.com/product/hologram?spm=5176.224200.h2v3icoap.186.58e16ed61Zjftc)。

    3.  单击**立即开通**，进入购买页面。

    4.  **商品类型**选择**共享集群（MaxCompute BI加速版）**，输入**实例名称**，选择目标**地域**，单击**立即购买**。

2.  查看实例。

    1.  成功购买实例后，进入[Hologres的管理控制台](https://hologram.console.aliyun.com/#/instance)。

    2.  在**Hologres引擎管理**页面，单击目标实例名称。

        您也可以单击目标实例**操作**列的**管理**，进入实例详情页，查看实例的详细信息。

        ![实例详情](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7901358061/p184909.png)

3.  新建数据库。

    成功创建实例后，系统默认生成一个名为**postgres**的数据库，用于监控管理，实际业务需要您新建数据库，操作如下：

    1.  在实例详情页的左侧导航栏，单击**DB管理**。

    2.  在**DB管理**页面，单击**新增Database**。

    3.  在**新增Database**对话框，输入**Database名称**，并根据实际业务选择是否**开启****简单权限模型**。

        ![新建](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4194458061/p136042.png)

        Hologres为您提供了**专家模式授权**和**简单权限模型**两套授权体系。

        **专家模式授权**与PostgreSQL的权限模型完全一致，简称专家模式，详情请参见[专家模式授权](/cn.zh-CN/用户授权及角色管理/专家模式授权.md)。

        **简单权限模型**是Hologres基于实际业务，为了简化授权操作而抽象的一套简单权限模型（SPM），详情请参见[简单权限模型概述](/cn.zh-CN/用户授权及角色管理/简单权限模型/简单权限模型概述.md)。

        创建数据库时，为了方便权限管理，建议您**开启****简单权限模型**。

    4.  单击**确定**。

        您可以在**DB管理**页面，查看已创建的数据库。

4.  连接开发工具。

    新建数据库后，您需要使用共享集群（MaxCompute BI加速版）实例连接原有的开发工具进行数据开发。

    连接开发工具时，需要将开发工具里原Lightning服务的Endpoint修改为对应共享集群（MaxCompute BI加速版）的Endpoint。

    本次试验以Hologres的自研开发工具HoloWeb为您演示，如何使用共享集群（MaxCompute BI加速版）实例连接开发工具，步骤如下：

    1.  在Hologres管理控制台的**Hologres引擎管理**页面，单击**登录Hologres数据库**，进入**HoloWeb**开发界面。

    2.  单击**连接管理** \> **数据连接**。

        ![数据连接](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0057818061/p116500.png)

    3.  配置**新建连接**对话框的参数。

        ![新建连接](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8413376061/p116502.png)

        参数描述如下表所示。

        |参数|描述|
        |--|--|
        |连接名称|自定义的连接名称。|
        |连接描述|连接的描述信息。|
        |网络类型|选择需要连接的网络类型及地域。网络类型如下：        -   公网
        -   VPC |
        |实例名称|根据实际业务选择所选地域已创建的实例。选择实例后，会自动显示该实例的主机和端口。 |
        |主机|Hologres实例的网络域名。进入[Hologres管理控制台](https://hologram.console.aliyun.com/#/instance)的实例详情页，从**实例配置**获取主机。 |
        |端口|Hologres实例的网络端口。进入[Hologres管理控制台](https://hologram.console.aliyun.com/#/instance)的实例详情页，从**实例配置**获取端口。 |
        |AccessKey ID|系统会自动显示当前账号的AccessKey ID。您也可以单击[AccessKey 管理](https://usercenter.console.aliyun.com/?spm=5176.2020520153.nav-right.dak.3bcf415dCWGUBj#/manage/ak)获取AccessKey ID。 |
        |AccessKey Secret|系统会自动显示当前账号的AccessKey Secret。您也可以单击[AccessKey 管理](https://usercenter.console.aliyun.com/?spm=5176.2020520153.nav-right.dak.3bcf415dCWGUBj#/manage/ak)获取。 |
        |测试连通性|检测数据连接是否成功：         -   成功：显示**测试通过**。
        -   不成功：显示**测试不通过**。 |

    4.  单击**确认**。

5.  MaxCompute加速查询。

    实例成功连接HoloWeb后，您可以创建外部表，加速查询MaxCompute的数据。新创建的外部表需要与MaxCompute表一一映射，其字段顺序和字段类型也需要与MaxCompute表保持一致。

    **说明：**

    -   您可以选择加速查询MaxCompute表的部分或全部字段。
    -   Hologres当前仅支持加速查询MaxCompute表，不支持加速查询MaxCompute的View或者其他类型的外部表。
    本次实验以在HoloWeb中新建外部表查询MaxCompute公共数据集中public\_data项目的表数据为例，步骤如下：

    **说明：** 获取表的方法请参见[公开数据集](https://yq.aliyun.com/articles/89763?spm=a2c4g.11186623.2.8.14d01099q4lXK2)。

    1.  新建外部表。

        1.  单击**连接管理** \> **外部表**，使用可视化的方式创建外部表。
        2.  在**新建外部表**的编辑页面，配置各项参数。

            ![表](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1180579061/p120737.png)

            参数描述如下表所示。

            |参数|描述|
            |--|--|
            |连接名|已配置的连接名称。|
            |数据库|Hologres的数据库名称。|
            |表名|新建的Hologres外部表名称。|
            |描述|新建的Hologres外部表信息描述。|
            |模式|模式名称。您可以选择默认创建的模式**public**，也可以选择新建的模式名称。 |
            |类型|外部表类型。目前仅支持MaxCompute。 |
            |服务器列表|创建外部查询MaxCompute数据是通过外部服务器来实现的。您可以直接调用Hologres底层已创建的名为**odps\_server**的外部表服务器。详细原理请参见[Postgres FDW](https://www.postgresql.org/docs/11/postgres-fdw.html?spm=a2c4g.11186623.2.11.7e476020Gyif3k)。|
            |表|MaxCompute的项目名和表名。格式为**project.table\_name**。

**说明：**

            -   目前暂不支持跨地域查询外部表数据。
            -   输入表名称后，会显示外部源表的所有字段。您可以选择同步外部源表的部分或所有字段至Hologres。 |

        3.  输入MaxCompute表的名称，就可以索引出表的字段，您可以根据实际业务，选择需要同步的表字段，单击**提交表**。
        如果您需要加速查询的外部表较多，则可以新建一个Query查询窗口，使用[IMPORT FOREIGN SCHEMA](/cn.zh-CN/Hologres SQL/DDL/SCHEMA/IMPORT FOREIGN SCHEMA.md)语句批量创建外部表。示例语句如下。创建Query查询窗口请参见[SQL窗口](/cn.zh-CN/连接开发工具/HoloWeb/SQL编辑器/SQL窗口.md) 。

        ```
        IMPORT FOREIGN SCHEMA public_data LIMIT to(
          customer,
          customer_address,
          customer_demographics,
          inventory,item,
          date_dim,
          warehouse) 
          FROM server odps_server INTO PUBLIC options(if_table_exist 'update');
        ```

    2.  加速查询外部表数据。

        加速查询外部表数据的示例SQL语句如下。

        ```
        # SQL1: 查询首选客户分布情况，按人数降序排列。
        SELECT c_preferred_cust_flag,
               count(*) AS cnt
        FROM customer
        WHERE c_preferred_cust_flag IS NOT NULL
        GROUP BY c_preferred_cust_flag
        ORDER BY cnt DESC LIMIT 10;
        
        # SQL2: 查询客户年龄人数大于1000的分布情况，按人数降序排列。
        SELECT c_birth_year,
               count(*) AS cnt
        FROM customer
        WHERE c_birth_year IS NOT NULL
        GROUP BY c_birth_year HAVING count(*) > 1000
        ORDER BY cnt DESC LIMIT 10;
        
        # SQL3: 查询客户所在城市的人数大于10的分布情况，按人数降序排序。
        SELECT ca_city,
               count(*) AS cnt
        FROM customer ,
             customer_address
        WHERE c_current_addr_sk = ca_address_sk
          AND ca_city IS NOT NULL
        GROUP BY ca_city HAVING count(*) > 10
        ORDER BY cnt DESC LIMIT 10;
        
        # SQL4: 查询首选客户出生于1980~1990年且所在城市的人数大于10的分布情况，按人数降序排列。
        SELECT ca_city,
               count(*) AS cnt
        FROM customer ,
             customer_address
        WHERE c_current_addr_sk = ca_address_sk
          AND c_birth_year >= 1980
          AND c_birth_year < 1990
          AND c_preferred_cust_flag = 'Y'
          AND ca_city IS NOT NULL
        GROUP BY ca_city HAVING count(*) > 10
        ORDER BY cnt DESC LIMIT 10;
        ```

6.  连接BI工具进行可视化分析。

    共享集群（MaxCompute BI加速版）兼容PostgreSQL生态，支持直接对接各种BI分析工具。连接BI工具时需要您修改原Lightning服务的Endpoint为共享集群（MaxCompute BI加速版）实例的Endpoint，然后再进行可视化分析。

    您可以根据业务情况选择连接合适的BI工具进行可视化分析。常见的BI工具请参见[概述](/cn.zh-CN/BI分析及可视化/概述.md)。

    本次实验以DataWorks的数据服务为例，为您介绍如何连接BI工具。步骤如下：

    1.  配置Hologres数据源。

        1.  登录[DataWorks管理控制台](https://workbench.data.aliyun.com/console?#/)。
        2.  在左侧导航栏，单击**工作空间列表**。
        3.  选择工作空间所在地域后，单击相应工作空间后的**进入数据集成**。
        4.  在左侧导航栏，单击**数据源**。
        5.  在**数据源管理**页面，单击顶部菜单栏的**新增数据源**。
        6.  在**大数据存储**区域，选择**Hologres**。
        7.  配置**新增Hologres数据源**对话框的各项参数。

            ![新增数据源](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1096705061/p139621.png)

            参数说明如下表所示。

            |参数|描述|
            |--|--|
            |数据源类型|目前仅支持**阿里云实例模式**。|
            |数据源名称|数据源名称必须是字母、数字和下划线的组合，并且以字母开头。|
            |数据源描述|数据源的信息描述，不得超过80个字符。|
            |适用环境|            -   **开发**
            -   **生产**
**说明：** 如果使用的是标准模式的DataWorks工作空间，则需要配置该参数。 |
            |实例ID|需要同步的Hologres实例ID。您可以进入[Hologres管理控制台](https://hologram.console.aliyun.com/#/instance)，获取实例ID。 |
            |数据库名|Hologres的数据库名称。|
            |AccessKey ID|您可以单击[AccessKey 管理](https://usercenter.console.aliyun.com/?spm=5176.2020520153.nav-right.dak.3bcf415dCWGUBj#/manage/ak)，获取AccessKey ID。|
            |AccessKey Secret|您可以单击[AccessKey 管理](https://usercenter.console.aliyun.com/?spm=5176.2020520153.nav-right.dak.3bcf415dCWGUBj#/manage/ak)，获取AccessKey Secret。|
            |资源组连通性|选择**数据服务**。您需要保证公共资源组和数据源是可以联通的。 |

    2.  生成并配置API。

        1.  在**DataWorks**开发界面，单击顶部菜单栏左侧的![图标](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4560129951/p139848.png)图标。
        2.  鼠标悬停至**全部产品**，在**数据开发**区域，单击**数据服务**。
        3.  在**服务开发**页面，鼠标悬停至![新建](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1771348951/p140098.png)图标。
        4.  鼠标悬停至**生成API**，您可以选择**向导模式**或**脚本模式**生成API。

            ![生成API](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1096705061/p140103.png)

            -   使用**向导模式**生成并配置API，详情请参见[通过向导模式生成API]()。
            -   使用**脚本模式**生成并配置API，详情请参见[通过脚本模式生成API]()。
    3.  测试API。

        1.  在API编辑页面，单击顶部菜单栏右侧的**测试**。
        2.  在**API测试**对话框，输入**请求参数**，单击**开始测试**。

            ![测试](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2771348951/p140167.png)

            如果**API测试**对话框页面底部显示**测试成功**，则表示API测试通过。您也可以使用数据服务的测试API模块来完成测试，详情请参见[测试API]()。

    4.  发布并查看API。

        1.  在API编辑页面，单击顶部菜单栏右侧的**发布**。

            发布API至API网关，并上架至API市场，详情请参见[发布API]()。

        2.  在**数据服务**页面，单击顶部菜单栏右侧的**服务管理**。
        3.  单击已发布的API名称，查看API详情。
    5.  调用API。

        如果您需要调用已成功发布的API，请参见[客户端调用API示例]()。


## 迁移用户权限

共享集群（MaxCompute BI加速版）的权限采用与Lightning服务不同的权限控制方式，需要您重新给用户授予相关权限，具体操作请参见[t1917293.dita\#task\_2569531](/cn.zh-CN/用户授权及角色管理/子账号使用Hologres/授予子账号实例的开发权限.md)。

